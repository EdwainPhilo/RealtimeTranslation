let socket = io();
let displayDiv = document.getElementById('textDisplay');
let server_available = false;
let mic_available = false;
let fullSentences = [];
let currentConfig = {}; // Â≠òÂÇ®ÂΩìÂâçÈÖçÁΩÆ‰ø°ÊÅØ
let waitingForConfigUpdate = false; // ÊòØÂê¶Ê≠£Âú®Á≠âÂæÖÈÖçÁΩÆÊõ¥Êñ∞
let useSimplifiedChinese = true; // ÊòØÂê¶‰ΩøÁî®ÁÆÄ‰Ωì‰∏≠Êñá
let originalFullSentences = []; // ‰øùÂ≠òÂéüÂßãÂè•Â≠êÔºàÊú™ËΩ¨Êç¢ÂâçÔºâ

// Ê∑ªÂä†Èò≤ÊäñÂèòÈáèÔºåÁî®‰∫éË∑üË∏™‰∏ä‰∏ÄÊ¨°ÊòæÁ§∫ÁöÑÁä∂ÊÄÅÊ∂àÊÅØ
let lastRecorderStatusMessage = '';
let lastRecorderStatusTime = 0;
const RECORDER_STATUS_DEBOUNCE_TIME = 3000; // 3ÁßíÂÜÖ‰∏çÈáçÂ§çÊòæÁ§∫Áõ∏ÂêåÊ∂àÊÅØ

// Â§ÑÁêÜÊñáÊú¨ËΩ¨Êç¢ÁöÑËæÖÂä©ÂáΩÊï∞
function processText(text) {
    return useSimplifiedChinese ? window.ChineseConverter.convertToSimplified(text) : text;
}

// Êõ¥Êñ∞ÊòæÁ§∫ÊñáÊú¨ÔºàËÄÉËôëÁπÅÁÆÄËΩ¨Êç¢Ôºâ
function updateDisplay() {
    displayDiv.innerHTML = originalFullSentences.map((sentence, index) => {
        const processedSentence = processText(sentence);
        let span = document.createElement('span');
        span.textContent = processedSentence + " ";
        span.className = index % 2 === 0 ? 'yellow' : 'cyan';
        return span.outerHTML;
    }).join('');
}

// ÂàáÊç¢ÁπÅÁÆÄÊòæÁ§∫Ê®°Âºè
function toggleChineseMode() {
    useSimplifiedChinese = !useSimplifiedChinese;
    // Êõ¥Êñ∞ÊòæÁ§∫
    updateDisplay();
    // Êõ¥Êñ∞ÊåâÈíÆÊñáÊú¨
    const toggleButton = document.getElementById('toggle-chinese-mode');
    if (toggleButton) {
        toggleButton.textContent = useSimplifiedChinese ? 'ÂàáÊç¢Âà∞ÁπÅ‰Ωì' : 'ÂàáÊç¢Âà∞ÁÆÄ‰Ωì';
    }

    // ‰øùÂ≠òÁî®Êà∑ÂÅèÂ•ΩÂà∞localStorage
    localStorage.setItem('useSimplifiedChinese', useSimplifiedChinese ? 'true' : 'false');

    // ÊòæÁ§∫Áä∂ÊÄÅÊ∂àÊÅØ
    showStatusMessage(useSimplifiedChinese ? 'Â∑≤ÂàáÊç¢Âà∞ÁÆÄ‰Ωì‰∏≠Êñá' : 'Â∑≤ÂàáÊç¢Âà∞ÁπÅ‰Ωì‰∏≠Êñá', true);
}

function displayRealtimeText(realtimeText, displayDiv) {
    let displayedText = fullSentences.map((sentence, index) => {
        let span = document.createElement('span');
        span.textContent = sentence + " ";
        span.className = index % 2 === 0 ? 'yellow' : 'cyan';
        return span.outerHTML;
    }).join('');

    // Ê∑ªÂä†ÂÆûÊó∂ÊñáÊú¨ÔºàÂ¶ÇÊûúÊúâÔºâ
    if (realtimeText) {
        let realtimeSpan = document.createElement('span');
        realtimeSpan.textContent = realtimeText;
        realtimeSpan.className = fullSentences.length % 2 === 0 ? 'yellow' : 'cyan';
        displayedText += realtimeSpan.outerHTML;
    }

    displayDiv.innerHTML = displayedText;
}

function start_msg() {
    if (!mic_available)
        displayRealtimeText("üé§  ËØ∑ÂÖÅËÆ∏È∫¶ÂÖãÈ£éËÆøÈóÆ  üé§", displayDiv);
    else if (!server_available)
        displayRealtimeText("üñ•Ô∏è  ËØ∑ÂêØÂä®ÊúçÂä°Âô®  üñ•Ô∏è", displayDiv);
    else
        displayRealtimeText("üëÑ  ÂºÄÂßãËØ¥ËØù  üëÑ", displayDiv);
}

// ÊòæÁ§∫Áä∂ÊÄÅÊ∂àÊÅØ
function showStatusMessage(message, isSuccess) {
    const statusElement = document.getElementById('status-message');
    if (!statusElement) return;

    statusElement.textContent = message;

    if (isSuccess) {
        statusElement.className = 'status-message success';
    } else {
        statusElement.className = 'status-message error';
    }

    // 3ÁßíÂêéËá™Âä®ÈöêËóè
    setTimeout(() => {
        statusElement.className = 'status-message';
    }, 3000);
}

// Êõ¥Êñ∞UI‰ª•ÂåπÈÖçÈÖçÁΩÆ
function updateSettingsUI(config) {
    if (!config) return;

    // Êõ¥Êñ∞Âü∫Êú¨ËÆæÁΩÆ
    if (config.model && document.getElementById('model-size')) {
        document.getElementById('model-size').value = config.model;
    }

    if (config.language !== undefined && document.getElementById('language')) {
        document.getElementById('language').value = config.language || '';
    }

    if (config.realtime_model_type && document.getElementById('realtime-model')) {
        document.getElementById('realtime-model').value = config.realtime_model_type;
    }

    // Êõ¥Êñ∞ËΩ¨ÂÜôËÆæÁΩÆ
    if (config.compute_type && document.getElementById('compute-type')) {
        document.getElementById('compute-type').value = config.compute_type;
    }

    if (config.beam_size !== undefined && document.getElementById('beam-size')) {
        document.getElementById('beam-size').value = config.beam_size.toString();
    }

    if (config.batch_size !== undefined && document.getElementById('batch-size')) {
        document.getElementById('batch-size').value = config.batch_size.toString();
    }

    if (config.beam_size_realtime !== undefined && document.getElementById('beam-size-realtime')) {
        document.getElementById('beam-size-realtime').value = config.beam_size_realtime.toString();
    }

    if (config.initial_prompt !== undefined && document.getElementById('initial-prompt')) {
        document.getElementById('initial-prompt').value = config.initial_prompt || '';
    }

    if (config.initial_prompt_realtime !== undefined && document.getElementById('initial-prompt-realtime')) {
        document.getElementById('initial-prompt-realtime').value = config.initial_prompt_realtime || '';
    }

    // Êõ¥Êñ∞ÂÆûÊó∂ËΩ¨ÂÜôËÆæÁΩÆ
    if (config.enable_realtime_transcription !== undefined && document.getElementById('enable-realtime')) {
        document.getElementById('enable-realtime').value = config.enable_realtime_transcription ? 'true' : 'false';
    }

    if (config.use_main_model_for_realtime !== undefined && document.getElementById('use-main-model-realtime')) {
        document.getElementById('use-main-model-realtime').value = config.use_main_model_for_realtime ? 'true' : 'false';
    }

    if (config.realtime_processing_pause !== undefined && document.getElementById('realtime-processing-pause')) {
        document.getElementById('realtime-processing-pause').value = config.realtime_processing_pause;
        document.getElementById('realtime-processing-pause-value').textContent = config.realtime_processing_pause;
    }

    if (config.init_realtime_after_seconds !== undefined && document.getElementById('init-realtime-after')) {
        document.getElementById('init-realtime-after').value = config.init_realtime_after_seconds;
        document.getElementById('init-realtime-after-value').textContent = config.init_realtime_after_seconds;
    }

    if (config.realtime_batch_size !== undefined && document.getElementById('realtime-batch-size')) {
        document.getElementById('realtime-batch-size').value = config.realtime_batch_size.toString();
    }

    // Êõ¥Êñ∞ËØ≠Èü≥Ê¥ªÂä®Ê£ÄÊµãËÆæÁΩÆ
    if (config.silero_sensitivity !== undefined && document.getElementById('silero-sensitivity')) {
        document.getElementById('silero-sensitivity').value = config.silero_sensitivity;
        document.getElementById('silero-value').textContent = config.silero_sensitivity;
    }

    if (config.silero_use_onnx !== undefined && document.getElementById('silero-use-onnx')) {
        document.getElementById('silero-use-onnx').value = config.silero_use_onnx ? 'true' : 'false';
    }

    if (config.silero_deactivity_detection !== undefined && document.getElementById('silero-deactivity')) {
        document.getElementById('silero-deactivity').value = config.silero_deactivity_detection ? 'true' : 'false';
    }

    if (config.webrtc_sensitivity !== undefined && document.getElementById('webrtc-sensitivity')) {
        document.getElementById('webrtc-sensitivity').value = config.webrtc_sensitivity;
        document.getElementById('webrtc-value').textContent = config.webrtc_sensitivity;
    }

    if (config.post_speech_silence_duration !== undefined && document.getElementById('silence-duration')) {
        document.getElementById('silence-duration').value = config.post_speech_silence_duration;
        document.getElementById('silence-value').textContent = config.post_speech_silence_duration;
    }

    if (config.min_length_of_recording !== undefined && document.getElementById('min-recording-length')) {
        document.getElementById('min-recording-length').value = config.min_length_of_recording;
        document.getElementById('min-recording-length-value').textContent = config.min_length_of_recording;
    }

    if (config.min_gap_between_recordings !== undefined && document.getElementById('min-gap')) {
        document.getElementById('min-gap').value = config.min_gap_between_recordings;
        document.getElementById('min-gap-value').textContent = config.min_gap_between_recordings;
    }

    if (config.pre_recording_buffer_duration !== undefined && document.getElementById('pre-recording-buffer')) {
        document.getElementById('pre-recording-buffer').value = config.pre_recording_buffer_duration;
        document.getElementById('pre-recording-buffer-value').textContent = config.pre_recording_buffer_duration;
    }

    // Êõ¥Êñ∞Âî§ÈÜíËØçËÆæÁΩÆ
    if (config.wakeword_backend !== undefined && document.getElementById('wakeword-backend')) {
        // Â¶ÇÊûú‰ΩøÁî®pvporcupine‰∏îÂî§ÈÜíËØç‰∏∫Á©∫ÔºåÂàôÊòæÁ§∫‰∏∫"‰∏çÂêØÁî®"
        if (config.wakeword_backend === 'pvporcupine' && (!config.wake_words || config.wake_words === '')) {
            document.getElementById('wakeword-backend').value = 'disabled';
        } else {
            document.getElementById('wakeword-backend').value = config.wakeword_backend;
        }
        // Ëß¶ÂèëÂêéÁ´ØÂàáÊç¢‰∫ã‰ª∂ÔºåÊõ¥Êñ∞UIÊòæÁ§∫
        const event = new Event('change');
        document.getElementById('wakeword-backend').dispatchEvent(event);
    }

    if (config.wake_words !== undefined && document.getElementById('wake-words')) {
        document.getElementById('wake-words').value = config.wake_words || '';
    }

    if (config.porcupine_access_key !== undefined && document.getElementById('porcupine-access-key')) {
        document.getElementById('porcupine-access-key').value = config.porcupine_access_key;
    }

    if (config.openwakeword_model_paths !== undefined && document.getElementById('openwakeword-models')) {
        document.getElementById('openwakeword-models').value = Array.isArray(config.openwakeword_model_paths) ?
            config.openwakeword_model_paths.join(',') :
            (config.openwakeword_model_paths || '');
    }

    if (config.openwakeword_inference_framework !== undefined && document.getElementById('openwakeword-framework')) {
        document.getElementById('openwakeword-framework').value = config.openwakeword_inference_framework;
    }

    if (config.wake_words_sensitivity !== undefined && document.getElementById('wake-words-sensitivity')) {
        document.getElementById('wake-words-sensitivity').value = config.wake_words_sensitivity;
        document.getElementById('wake-words-sensitivity-value').textContent = config.wake_words_sensitivity;
    }

    if (config.wake_word_timeout !== undefined && document.getElementById('wake-word-timeout')) {
        document.getElementById('wake-word-timeout').value = config.wake_word_timeout;
        document.getElementById('wake-word-timeout-value').textContent = config.wake_word_timeout;
    }

    if (config.wake_word_buffer_duration !== undefined && document.getElementById('wake-word-buffer')) {
        document.getElementById('wake-word-buffer').value = config.wake_word_buffer_duration;
        document.getElementById('wake-word-buffer-value').textContent = config.wake_word_buffer_duration;
    }

    if (config.wake_word_activation_delay !== undefined && document.getElementById('wake-word-activation-delay')) {
        document.getElementById('wake-word-activation-delay').value = config.wake_word_activation_delay;
        document.getElementById('wake-word-activation-delay-value').textContent = config.wake_word_activation_delay;
    }

    // Êõ¥Êñ∞Á≥ªÁªüËÆæÁΩÆ
    if (config.buffer_size !== undefined && document.getElementById('buffer-size')) {
        document.getElementById('buffer-size').value = config.buffer_size.toString();
    }

    if (config.sample_rate !== undefined && document.getElementById('sample-rate')) {
        document.getElementById('sample-rate').value = config.sample_rate.toString();
    }

    if (config.suppress_tokens !== undefined && document.getElementById('suppress-tokens')) {
        document.getElementById('suppress-tokens').value = config.suppress_tokens.join(',');
    }

    if (config.print_transcription_time !== undefined && document.getElementById('print-transcription-time')) {
        document.getElementById('print-transcription-time').value = config.print_transcription_time ? 'true' : 'false';
    }

    if (config.early_transcription_on_silence !== undefined && document.getElementById('early-transcription-silence')) {
        document.getElementById('early-transcription-silence').value = config.early_transcription_on_silence;
        document.getElementById('early-transcription-silence-value').textContent = config.early_transcription_on_silence;
    }

    if (config.allowed_latency_limit !== undefined && document.getElementById('allowed-latency')) {
        document.getElementById('allowed-latency').value = config.allowed_latency_limit;
        document.getElementById('allowed-latency-value').textContent = config.allowed_latency_limit;
    }

    if (config.debug_mode !== undefined && document.getElementById('debug-mode')) {
        document.getElementById('debug-mode').value = config.debug_mode ? 'true' : 'false';
    }

    if (config.handle_buffer_overflow !== undefined && document.getElementById('handle-buffer-overflow')) {
        document.getElementById('handle-buffer-overflow').value = config.handle_buffer_overflow ? 'true' : 'false';
    }

    if (config.no_log_file !== undefined && document.getElementById('no-log-file')) {
        document.getElementById('no-log-file').value = config.no_log_file ? 'true' : 'false';
    }

    if (config.use_extended_logging !== undefined && document.getElementById('use-extended-logging')) {
        document.getElementById('use-extended-logging').value = config.use_extended_logging ? 'true' : 'false';
    }
}

// ‰ªéUIËé∑ÂèñÂΩìÂâçÈÖçÁΩÆ
function getConfigFromUI() {
    const config = {
        // Âü∫Êú¨ËÆæÁΩÆ
        'model': document.getElementById('model-size').value,
        'language': document.getElementById('language').value,
        'download_root': null,
        'compute_type': document.getElementById('compute-type').value,
        'input_device_index': null,
        'gpu_device_index': 0,
        'device': 'cuda',
        'spinner': false,
        'use_microphone': false,
        'ensure_sentence_starting_uppercase': true,
        'ensure_sentence_ends_with_period': true,
        'batch_size': parseInt(document.getElementById('batch-size').value),
        'level': 30, // WARNING Á∫ßÂà´

        // ÂÆûÊó∂ËΩ¨ÂÜôËÆæÁΩÆ
        'enable_realtime_transcription': document.getElementById('enable-realtime').value === 'true',
        'use_main_model_for_realtime': document.getElementById('use-main-model-realtime').value === 'true',
        'realtime_model_type': document.getElementById('realtime-model').value,
        'realtime_processing_pause': parseFloat(document.getElementById('realtime-processing-pause').value),
        'init_realtime_after_seconds': parseFloat(document.getElementById('init-realtime-after').value),
        'realtime_batch_size': parseInt(document.getElementById('realtime-batch-size').value),

        // ËØ≠Èü≥Ê¥ªÂä®Ê£ÄÊµãËÆæÁΩÆ
        'silero_sensitivity': parseFloat(document.getElementById('silero-sensitivity').value),
        'silero_use_onnx': document.getElementById('silero-use-onnx').value === 'true',
        'silero_deactivity_detection': document.getElementById('silero-deactivity').value === 'true',
        'webrtc_sensitivity': parseInt(document.getElementById('webrtc-sensitivity').value),
        'post_speech_silence_duration': parseFloat(document.getElementById('silence-duration').value),
        'min_length_of_recording': parseFloat(document.getElementById('min-recording-length').value),
        'min_gap_between_recordings': parseFloat(document.getElementById('min-gap').value),
        'pre_recording_buffer_duration': parseFloat(document.getElementById('pre-recording-buffer').value),

        // Âî§ÈÜíËØçËÆæÁΩÆ
        'wakeword_backend': document.getElementById('wakeword-backend').value === 'disabled' ? 'pvporcupine' : document.getElementById('wakeword-backend').value,
        'porcupine_access_key': document.getElementById('porcupine-access-key') ? 
            document.getElementById('porcupine-access-key').value.trim() : 
            '',
        'openwakeword_model_paths': document.getElementById('openwakeword-models') ?
            document.getElementById('openwakeword-models').value.trim() || null :
            null,
        'openwakeword_inference_framework': document.getElementById('openwakeword-framework') ?
            document.getElementById('openwakeword-framework').value :
            "onnx",
        'wake_words': document.getElementById('wakeword-backend').value === 'disabled' ? '' : 
            (document.getElementById('wakeword-backend').value === 'pvporcupine' && document.getElementById('wake-words') ? 
                document.getElementById('wake-words').value.trim() : 
                document.getElementById('wake-words').value),
        'wake_words_sensitivity': parseFloat(document.getElementById('wake-words-sensitivity').value),
        'wake_word_activation_delay': parseFloat(document.getElementById('wake-word-activation-delay').value),
        'wake_word_timeout': parseFloat(document.getElementById('wake-word-timeout').value),
        'wake_word_buffer_duration': parseFloat(document.getElementById('wake-word-buffer').value),

        // È´òÁ∫ßËÆæÁΩÆ
        'beam_size': parseInt(document.getElementById('beam-size').value),
        'beam_size_realtime': parseInt(document.getElementById('beam-size-realtime').value),
        'buffer_size': parseInt(document.getElementById('buffer-size').value),
        'sample_rate': parseInt(document.getElementById('sample-rate').value),
        'initial_prompt': document.getElementById('initial-prompt').value || null,
        'initial_prompt_realtime': document.getElementById('initial-prompt-realtime').value || null,
        'suppress_tokens': [-1], // Ëß£Êûêsuppress-tokensÁöÑÂÄºÂèØËÉΩÈúÄË¶ÅÊõ¥Â§çÊùÇÁöÑÈÄªËæë
        'print_transcription_time': document.getElementById('print-transcription-time').value === 'true',
        'early_transcription_on_silence': parseFloat(document.getElementById('early-transcription-silence').value),
        'allowed_latency_limit': parseFloat(document.getElementById('allowed-latency').value),
        'debug_mode': document.getElementById('debug-mode').value === 'true',
        'handle_buffer_overflow': document.getElementById('handle-buffer-overflow').value === 'true',
        'no_log_file': document.getElementById('no-log-file').value === 'true',
        'use_extended_logging': document.getElementById('use-extended-logging').value === 'true'
    };

    // Â§ÑÁêÜsuppress-tokens
    if (document.getElementById('suppress-tokens').value) {
        try {
            const tokens = document.getElementById('suppress-tokens').value.split(',').map(t => parseInt(t.trim()));
            if (tokens.length > 0 && !isNaN(tokens[0])) {
                config.suppress_tokens = tokens;
            }
        } catch (e) {
            console.warn("Êó†Ê≥ïËß£Êûêsuppress-tokensÂÄºÔºå‰ΩøÁî®ÈªòËÆ§ÂÄº");
        }
    }

    return config;
}

// ÂàùÂßãÂåñSocket.IOËøûÊé•
socket.on('connect', function () {
    server_available = true;
    start_msg();

    // ËøûÊé•ÂêéËØ∑Ê±ÇÂΩìÂâçÈÖçÁΩÆ
    socket.emit('get_config');
});

socket.on('disconnect', function () {
    server_available = false;
    start_msg();
});

// Â§ÑÁêÜÊ®°ÂûãË∑ØÂæÑÈáçÁΩÆ‰∫ã‰ª∂
socket.on('model_path_reset', function (data) {
    console.warn('Ê®°ÂûãË∑ØÂæÑÈáçÁΩÆ:', data);

    // ÊòæÁ§∫ÁÆÄÁü≠ÈÄöÁü•
    showStatusMessage('Ê£ÄÊµãÂà∞Êó†ÊïàÁöÑÊ®°ÂûãÊñá‰ª∂ÔºåÂ∑≤Ëá™Âä®ÈáçÁΩÆ‰∏∫ÈªòËÆ§Ê®°Âûã', false);

    // Â¶ÇÊûúÂΩìÂâçÊ≠£Âú®ËÆæÁΩÆÈ°µÈù¢ÔºåÊõ¥Êñ∞UIÂπ∂È´ò‰∫ÆÊòæÁ§∫
    const modelPathInput = document.getElementById('openwakeword-models');
    if (modelPathInput) {
        // Ê∏ÖÁ©∫ËæìÂÖ•Ê°Ü
        modelPathInput.value = '';

        // Ê∑ªÂä†ÈîôËØØÊ†∑Âºè
        modelPathInput.classList.add('validation-error');

        // ÊòæÁ§∫ÈîôËØØÊ∂àÊÅØ
        showValidationError('openwakeword-models', 'Ê£ÄÊµãÂà∞Êó†ÊïàÁöÑÊ®°ÂûãÊñá‰ª∂ÔºåÂ∑≤Ëá™Âä®ÈáçÁΩÆ‰∏∫ÈªòËÆ§ÂÄº');
    }

    // ‰∏çÈúÄË¶ÅÈ¢ùÂ§ñÁöÑÂÄíËÆ°Êó∂ÂíåÂà∑Êñ∞ÈÄªËæëÔºåÈáçÂêØÈ°µÈù¢‰ºöÂ§ÑÁêÜËøô‰∫õ
});

socket.on('realtime', function (data) {
    if (data.type === 'realtime') {
        // ‰ΩøÁî®ËæÖÂä©ÂáΩÊï∞Â§ÑÁêÜÊñáÊú¨
        const processedText = processText(data.text);
        displayRealtimeText(processedText, displayDiv);
    }
});

socket.on('fullSentence', function (data) {
    if (data.type === 'fullSentence') {
        // ‰øùÂ≠òÂéüÂßãÂè•Â≠êÔºàÊú™ËΩ¨Êç¢Ôºâ
        originalFullSentences.push(data.text);
        // ‰ΩøÁî®ËæÖÂä©ÂáΩÊï∞Â§ÑÁêÜÊñáÊú¨
        const processedText = processText(data.text);
        fullSentences.push(processedText);

        // Êõ¥Êñ∞ÊòæÁ§∫
        updateDisplay();
    }
});

// Êé•Êî∂ÊúçÂä°Âô®ÈÖçÁΩÆ
socket.on('config', function (config) {
    currentConfig = config;
    updateSettingsUI(config);
    console.log('Êî∂Âà∞ÊúçÂä°Âô®ÈÖçÁΩÆ:', config);

    // Ê£ÄÊü•ÊòØÂê¶ÊúâÂêØÂä®ÈîôËØØ‰ø°ÊÅØ
    if (config.startup_error) {
        showStartupErrorDialog(config.startup_error);
    }
});

// ÈÖçÁΩÆÊõ¥Êñ∞ÂìçÂ∫î
socket.on('config_updated', function (response) {
    if (response.success) {
        currentConfig = response.config;
        updateSettingsUI(response.config);
        showStatusMessage('ËÆæÁΩÆÂ∑≤ÊàêÂäüÂ∫îÁî®ÔºåÁ≠âÂæÖÂΩïÈü≥Êú∫Â∞±Áª™...', true);
        // ËÆ∞ÂΩïÊ≠£Âú®Á≠âÂæÖÂΩïÈü≥Êú∫Â∞±Áª™
        waitingForConfigUpdate = true;
    } else {
        showStatusMessage('ËÆæÁΩÆÂ∫îÁî®Â§±Ë¥•: ' + response.error, false);
        // ÈÖçÁΩÆÊõ¥Êñ∞Â§±Ë¥•ÔºåÈáçÁΩÆÁ≠âÂæÖÁä∂ÊÄÅ
        waitingForConfigUpdate = false;
    }
});

// ËÆæÁΩÆÂΩïÈü≥Êú∫Áä∂ÊÄÅ
socket.on('recorder_status', function (data) {
    const currentTime = Date.now();
    const message = data.ready ? 'ÂΩïÈü≥Êú∫Â∑≤ÂáÜÂ§áÂ∞±Áª™' : 'ÂΩïÈü≥Êú∫Êú™Â∞±Áª™';
    
    // Â¶ÇÊûúÊòØÁõ∏ÂêåÊ∂àÊÅØ‰∏îÊó∂Èó¥Èó¥ÈöîÂ∞è‰∫éÈò≤ÊäñÊó∂Èó¥ÔºåÂàô‰∏çÊòæÁ§∫
    if (message === lastRecorderStatusMessage && 
        (currentTime - lastRecorderStatusTime) < RECORDER_STATUS_DEBOUNCE_TIME) {
        return;
    }
    
    // Êõ¥Êñ∞ÊúÄÂêéÊòæÁ§∫ÁöÑÊ∂àÊÅØÂíåÊó∂Èó¥
    lastRecorderStatusMessage = message;
    lastRecorderStatusTime = currentTime;
    
    if (data.ready) {
        if (waitingForConfigUpdate) {
            // Â¶ÇÊûúÊòØÈÖçÁΩÆÊõ¥Êñ∞ÂêéÁöÑÁä∂ÊÄÅÂèòÊõ¥ÔºåÂàôÂÖ≥Èó≠ËÆæÁΩÆÈù¢Êùø
            waitingForConfigUpdate = false;
            showStatusMessage('ÂΩïÈü≥Êú∫Â∑≤ÂáÜÂ§áÂ∞±Áª™', true);

            // Âª∂Ëøü‰∏ÄÁßíÂÖ≥Èó≠ËÆæÁΩÆÈù¢ÊùøÔºåËÆ©Áî®Êà∑ÁúãÂà∞ÊàêÂäüÊ∂àÊÅØ
            setTimeout(() => {
                const settingsOverlay = document.getElementById('settingsOverlay');
                if (settingsOverlay) {
                    settingsOverlay.style.display = 'none';
                }
            }, 1000);
        } else {
            showStatusMessage('ÂΩïÈü≥Êú∫Â∑≤ÂáÜÂ§áÂ∞±Áª™', true);
        }
    } else {
        showStatusMessage('ÂΩïÈü≥Êú∫Êú™Â∞±Áª™', false);
    }
});

// Â§ÑÁêÜÂ∫îÁî®ÈáçÂêØÊ∂àÊÅØ
socket.on('restart_required', function (data) {
    console.log('Â∫îÁî®Âç≥Â∞ÜÈáçÂêØ:', data);

    // Â¶ÇÊûúÊèê‰æõ‰∫ÜÈáçÂÆöÂêëURLÔºåÂàôÂú®ÂÄíËÆ°Êó∂ÁªìÊùüÂêéÈáçÂÆöÂêë
    if (data.redirect_to) {
        // ÊòæÁ§∫ÁÆÄÂçïÁöÑÈáçÂêØÊ∂àÊÅØ
        displayDiv.innerHTML = `<span class="restart-message">Â∫îÁî®Ê≠£Âú®ÈáçÂêØÔºå${data.countdown || 3}ÁßíÂêéÂ∞ÜË∑≥ËΩ¨Âà∞ÈáçÂêØÈ°µÈù¢...</span>`;

        // ÂÄíËÆ°Êó∂ÁªìÊùüÂêéÈáçÂÆöÂêë
        setTimeout(function () {
            window.location.href = data.redirect_to;
        }, (data.countdown || 3) * 1000);

        return; // ‰∏çÊòæÁ§∫ÂØπËØùÊ°ÜÔºåÁõ¥Êé•ËøîÂõû
    }

    // ÊóßÁöÑÂ§ÑÁêÜÈÄªËæëÂ∑≤Ë¢´ÁßªÈô§ÔºåÁé∞Âú®ÊâÄÊúâÈáçÂêØÈÉΩÂ∫îËØ•‰ΩøÁî®ÈáçÂÆöÂêë
    console.warn('Êî∂Âà∞Ê≤°ÊúâÈáçÂÆöÂêëURLÁöÑÈáçÂêØËØ∑Ê±ÇÔºåÂ∞ÜÂà∑Êñ∞È°µÈù¢');

    // ÊòæÁ§∫ÁÆÄÂçïÁöÑÈáçÂêØÊ∂àÊÅØ
    displayDiv.innerHTML = `<span class="restart-message">Â∫îÁî®Ê≠£Âú®ÈáçÂêØÔºåÈ°µÈù¢Â∞ÜÂú®5ÁßíÂêéÂà∑Êñ∞...</span>`;

    // 5ÁßíÂêéÂà∑Êñ∞È°µÈù¢ÔºàÂÖºÂÆπÊóßÁâàÊú¨Ôºâ
    setTimeout(function () {
        window.location.reload();
    }, 5000);
});

start_msg();

// ÂΩìDOMÂä†ËΩΩÂÆåÊàêÔºåËÆæÁΩÆÊåâÈíÆ‰∫ã‰ª∂
document.addEventListener('DOMContentLoaded', function () {
    const applySettingsBtn = document.getElementById('apply-settings');
    if (applySettingsBtn) {
        applySettingsBtn.addEventListener('click', async function () {
            const config = getConfigFromUI();

            // È™åËØÅPorcupineËÆæÁΩÆ
            if (config.wakeword_backend === 'pvporcupine') {
                // Âè™ÊúâÂΩìÂî§ÈÜíËØç‰∏ç‰∏∫Á©∫Êó∂ÔºåÊâçË¶ÅÊ±Çaccess_keyÂøÖÂ°´
                if (config.wake_words && config.wake_words.trim() && !config.porcupine_access_key) {
                    showValidationError('porcupine-access-key', 'PorcupineËÆøÈóÆÂØÜÈí•‰∏çËÉΩ‰∏∫Á©∫ÔºàÂî§ÈÜíËØçÂ≠òÂú®Êó∂ÂøÖÂ°´Ôºâ');
                    showStatusMessage('ËÆæÁΩÆÈ™åËØÅÂ§±Ë¥•ÔºåËØ∑‰øÆÊ≠£ÈîôËØØÂêéÈáçËØï', false);
                    return; // ÈòªÊ≠¢Êèê‰∫§
                }
            }

            // È™åËØÅOpenWakeWordÊ®°ÂûãË∑ØÂæÑ
            if (config.wakeword_backend === 'openwakeword' && document.getElementById('openwakeword-models')) {
                const pathsString = document.getElementById('openwakeword-models').value;

                // È¶ñÂÖàËøõË°åÊ†ºÂºèÈ™åËØÅ
                const formatValidation = validateOpenWakeWordPaths(pathsString);
                if (!formatValidation.valid) {
                    showValidationError('openwakeword-models', formatValidation.message);
                    showStatusMessage('ËÆæÁΩÆÈ™åËØÅÂ§±Ë¥•ÔºåËØ∑‰øÆÊ≠£ÈîôËØØÂêéÈáçËØï', false);
                    return; // ÈòªÊ≠¢Êèê‰∫§
                }

                // ÁÑ∂ÂêéÈ™åËØÅÊñá‰ª∂ÊòØÂê¶Â≠òÂú®ÔºàÂ¶ÇÊûúË∑ØÂæÑ‰∏ç‰∏∫Á©∫Ôºâ
                if (pathsString.trim()) {
                    try {
                        showStatusMessage('Ê≠£Âú®È™åËØÅÊñá‰ª∂Ë∑ØÂæÑ...', true);
                        const fileValidation = await validateFilePath(pathsString);

                        // ÊòæÁ§∫È™åËØÅÁªìÊûú
                        showFileValidationResult('openwakeword-models', fileValidation);

                        // Â¶ÇÊûúÈ™åËØÅÂ§±Ë¥•ÔºåÈòªÊ≠¢Êèê‰∫§
                        if (!fileValidation.valid) {
                            showStatusMessage('Êñá‰ª∂Ë∑ØÂæÑÈ™åËØÅÂ§±Ë¥•ÔºåËØ∑‰øÆÊ≠£ÈîôËØØÂêéÈáçËØï', false);
                            return;
                        }
                    } catch (error) {
                        console.error('Êñá‰ª∂È™åËØÅÂá∫Èîô:', error);
                        // Â¶ÇÊûúÈ™åËØÅËøáÁ®ãÂá∫ÈîôÔºå‰ªçÁÑ∂ÂÖÅËÆ∏Êèê‰∫§Ôºå‰ΩÜÊòæÁ§∫Ë≠¶Âëä
                        showStatusMessage('Êñá‰ª∂È™åËØÅËøáÁ®ãÂá∫ÈîôÔºåÂ∞ÜÁªßÁª≠Êèê‰∫§ËÆæÁΩÆÔºå‰ΩÜÂèØËÉΩÂØºËá¥ÂΩïÈü≥ÊúçÂä°ÂêØÂä®Â§±Ë¥•', false);
                    }
                }

                clearValidationError('openwakeword-models', true); // ÊòæÁ§∫ÊàêÂäüÁä∂ÊÄÅ
            }

            socket.emit('update_config', config);
            console.log('ÂèëÈÄÅÈÖçÁΩÆÂà∞ÊúçÂä°Âô®:', config);

            // ÊòæÁ§∫Ê≠£Âú®Êõ¥Êñ∞ÁöÑÊ∂àÊÅØ
            showStatusMessage('Ê≠£Âú®Â∫îÁî®ËÆæÁΩÆ...', true);
            // ‰∏çÁ´ãÂç≥ÂÖ≥Èó≠ËÆæÁΩÆÈù¢ÊùøÔºåËÄåÊòØÁ≠âÂæÖÂìçÂ∫î
            waitingForConfigUpdate = true;
        });
    }

    // ÊÅ¢Â§çÈªòËÆ§ËÆæÁΩÆÊåâÈíÆ
    const resetToDefaultBtn = document.getElementById('reset-to-default');
    if (resetToDefaultBtn) {
        resetToDefaultBtn.addEventListener('click', function () {
            if (confirm('Á°ÆÂÆöË¶ÅÊÅ¢Â§çÊâÄÊúâËÆæÁΩÆÂà∞ÈªòËÆ§ÂÄºÂêóÔºüÊ≠§Êìç‰ΩúÊó†Ê≥ïÊí§ÈîÄ„ÄÇ')) {
                socket.emit('reset_to_default');
                console.log('ÂèëÈÄÅÊÅ¢Â§çÈªòËÆ§ËÆæÁΩÆËØ∑Ê±Ç');

                // ÊòæÁ§∫Ê≠£Âú®ÊÅ¢Â§çÁöÑÊ∂àÊÅØ
                showStatusMessage('Ê≠£Âú®ÊÅ¢Â§çÈªòËÆ§ËÆæÁΩÆ...', true);
            }
        });
    }

    // ‰ªélocalStorageÂä†ËΩΩÁî®Êà∑ÁöÑÁÆÄÁπÅ‰∏≠ÊñáÂÅèÂ•Ω
    const savedPreference = localStorage.getItem('useSimplifiedChinese');
    if (savedPreference !== null) {
        useSimplifiedChinese = savedPreference === 'true';
        // Êõ¥Êñ∞ÂàáÊç¢ÊåâÈíÆÊñáÊú¨
        const toggleButton = document.getElementById('toggle-chinese-mode');
        if (toggleButton) {
            toggleButton.textContent = useSimplifiedChinese ? 'ÂàáÊç¢Âà∞ÁπÅ‰Ωì' : 'ÂàáÊç¢Âà∞ÁÆÄ‰Ωì';
        }
    }

    // Ëé∑ÂèñÊåâÈíÆÂíåÂØπËØùÊ°ÜÂÖÉÁ¥†
    const shutdownIcon = document.getElementById('shutdownIcon');
    const shutdownDialog = document.getElementById('shutdownConfirmDialog');
    const confirmShutdownBtn = document.getElementById('confirmShutdown');
    const cancelShutdownBtn = document.getElementById('cancelShutdown');

    // ÊòæÁ§∫Á°ÆËÆ§ÂØπËØùÊ°Ü
    shutdownIcon.addEventListener('click', function () {
        shutdownDialog.style.display = 'flex';
    });

    // ÂèñÊ∂àÂÖ≥Èó≠
    cancelShutdownBtn.addEventListener('click', function () {
        shutdownDialog.style.display = 'none';
    });

    // Á°ÆËÆ§ÂÖ≥Èó≠
    confirmShutdownBtn.addEventListener('click', function () {
        shutdownDialog.style.display = 'none';

        // ÂèëÈÄÅÂÖ≥Èó≠ËØ∑Ê±ÇÂà∞ÊúçÂä°Âô®
        socket.emit('shutdown_service');

        // ÊòæÁ§∫ÂÖ≥Èó≠Áä∂ÊÄÅ
        displayDiv.innerHTML = '<span class="shutdown-message">ÊúçÂä°Ê≠£Âú®ÂÖ≥Èó≠ÔºåËØ∑Á®çÂÄô...</span>';
    });

    // ÁÇπÂáªÂØπËØùÊ°ÜÂ§ñÈÉ®Âå∫ÂüüÂÖ≥Èó≠ÂØπËØùÊ°Ü
    shutdownDialog.addEventListener('click', function (event) {
        if (event.target === shutdownDialog) {
            shutdownDialog.style.display = 'none';
        }
    });

    // ÁõëÂê¨ÊúçÂä°ÂÖ≥Èó≠‰∫ã‰ª∂
    socket.on('service_shutdown', function (data) {
        console.log('ÊúçÂä°Ê≠£Âú®ÂÖ≥Èó≠:', data);

        // ÊòæÁ§∫ÂÖ≥Èó≠ÂÄíËÆ°Êó∂
        displayDiv.innerHTML = `<span class="shutdown-message">ÊúçÂä°Ê≠£Âú®ÂÖ≥Èó≠Ôºå${data.countdown}ÁßíÂêéÂ∞ÜËá™Âä®Êñ≠ÂºÄËøûÊé•...</span>`;

        // ÂÄíËÆ°Êó∂ÁªìÊùüÂêéÂà∑Êñ∞È°µÈù¢
        setTimeout(function () {
            displayDiv.innerHTML = '<span class="shutdown-message">ÊúçÂä°Â∑≤ÂÖ≥Èó≠ÔºåËØ∑ÂÖ≥Èó≠ÊµèËßàÂô®ÊàñÂà∑Êñ∞È°µÈù¢ÈáçÊñ∞ËøûÊé•</span>';
        }, data.countdown * 1000);
    });

    // ÂàùÂßãÂåñÂî§ÈÜíËØçËÆæÁΩÆUIÁä∂ÊÄÅ
    const wakewordBackend = document.getElementById('wakeword-backend');
    if (wakewordBackend) {
        const settingGroup = wakewordBackend.closest('.setting-group');
        if (settingGroup) {
            // ÈªòËÆ§ÊòæÁ§∫OpenWakeWordËÆæÁΩÆ
            settingGroup.classList.add('openwakeword-active');
        }
    }

    // ‰∏∫OpenWakeWordÊ®°ÂûãË∑ØÂæÑËæìÂÖ•Ê°ÜÊ∑ªÂä†È™åËØÅ‰∫ã‰ª∂
    const openwakewordModelsInput = document.getElementById('openwakeword-models');
    if (openwakewordModelsInput) {
        // ÂÆûÊó∂Ê†ºÂºèÈ™åËØÅ
        openwakewordModelsInput.addEventListener('input', function () {
            const formatValidation = validateOpenWakeWordPaths(this.value);
            if (!formatValidation.valid) {
                showValidationError('openwakeword-models', formatValidation.message);
            } else {
                // Âè™Ê∏ÖÈô§ÈîôËØØÔºå‰∏çÊòæÁ§∫ÊàêÂäüÁä∂ÊÄÅÔºàÁïôÁªôÊñá‰ª∂Â≠òÂú®È™åËØÅÔºâ
                clearValidationError('openwakeword-models');
            }
        });

        // Ê∑ªÂä†Â§±ÂéªÁÑ¶ÁÇπÊó∂È™åËØÅÊñá‰ª∂Ë∑ØÂæÑ
        openwakewordModelsInput.addEventListener('blur', async function () {
            // È¶ñÂÖàËøõË°åÊ†ºÂºèÈ™åËØÅ
            const formatValidation = validateOpenWakeWordPaths(this.value);
            if (!formatValidation.valid) {
                showValidationError('openwakeword-models', formatValidation.message);
                return;
            }

            // Â¶ÇÊûúÊ†ºÂºèÈ™åËØÅÈÄöËøá‰∏îÂÄº‰∏ç‰∏∫Á©∫ÔºåÈ™åËØÅÊñá‰ª∂Ë∑ØÂæÑ
            if (this.value.trim()) {
                try {
                    const fileValidation = await validateFilePath(this.value);
                    showFileValidationResult('openwakeword-models', fileValidation);
                } catch (error) {
                    console.error('Êñá‰ª∂È™åËØÅÂá∫Èîô:', error);
                    // ÊòæÁ§∫Ë≠¶Âëä‰ΩÜ‰∏çÈòªÊ≠¢Áî®Êà∑ÁªßÁª≠
                    showValidationError('openwakeword-models', 'Êó†Ê≥ïÈ™åËØÅÊñá‰ª∂ÊòØÂê¶Â≠òÂú®: ' + error.message);
                }
            } else {
                clearValidationError('openwakeword-models');
            }
        });

        // ÂàùÂßãÊ†ºÂºèÈ™åËØÅ
        const formatValidation = validateOpenWakeWordPaths(openwakewordModelsInput.value);
        if (formatValidation.valid && openwakewordModelsInput.value.trim()) {
            // Â¶ÇÊûúÂàùÂßãÂÄºÊ†ºÂºèÊ≠£Á°Æ‰∏î‰∏ç‰∏∫Á©∫ÔºåÂ∞ùËØïÈ™åËØÅÊñá‰ª∂Â≠òÂú®ÊÄß
            validateFilePath(openwakewordModelsInput.value)
                .then(result => showFileValidationResult('openwakeword-models', result))
                .catch(error => console.error('ÂàùÂßãÊñá‰ª∂È™åËØÅÂ§±Ë¥•:', error));
        } else if (!formatValidation.valid) {
            showValidationError('openwakeword-models', formatValidation.message);
        }
    }

    // ‰∏∫ËæìÂÖ•Ê°ÜÊ∑ªÂä†input‰∫ã‰ª∂ÁõëÂê¨Âô®ÔºåÂΩìÁî®Êà∑ËæìÂÖ•ÂÜÖÂÆπÊó∂Ëá™Âä®Ê∏ÖÈô§ÈîôËØØÁä∂ÊÄÅ
    const porcupineAccessKey = document.getElementById('porcupine-access-key');
    const wakeWords = document.getElementById('wake-words');
    const wakewordBackendSelect = document.getElementById('wakeword-backend');
    
    if (wakewordBackendSelect) {
        wakewordBackendSelect.addEventListener('change', function() {
            // ÂΩìÂàáÊç¢Âà∞ÈùûpvporcupineÊó∂ÔºåÊ∏ÖÈô§Áõ∏ÂÖ≥ÈîôËØØÁä∂ÊÄÅ
            if (this.value !== 'pvporcupine') {
                clearValidationError('porcupine-access-key');
                clearValidationError('wake-words');
            }
        });
    }
    
    if (porcupineAccessKey) {
        porcupineAccessKey.addEventListener('input', function() {
            if (this.value.trim()) {
                clearValidationError('porcupine-access-key');
            }
        });
    }
    
    if (wakeWords) {
        wakeWords.addEventListener('input', function() {
            if (this.value.trim()) {
                clearValidationError('wake-words');
            }
        });
    }
});

// ËØ∑Ê±ÇÈ∫¶ÂÖãÈ£éËÆøÈóÆÊùÉÈôê
navigator.mediaDevices.getUserMedia({audio: true})
    .then(stream => {
        let audioContext = new AudioContext();
        let source = audioContext.createMediaStreamSource(stream);
        let processor = audioContext.createScriptProcessor(256, 1, 1);

        source.connect(processor);
        processor.connect(audioContext.destination);
        mic_available = true;
        start_msg();

        processor.onaudioprocess = function (e) {
            let inputData = e.inputBuffer.getChannelData(0);
            let outputData = new Int16Array(inputData.length);

            // Convert to 16-bit PCM
            for (let i = 0; i < inputData.length; i++) {
                outputData[i] = Math.max(-32768, Math.min(32767, inputData[i] * 32768));
            }

            // Â∞ÜÈü≥È¢ëÊï∞ÊçÆËΩ¨Êç¢‰∏∫ Base64 ÁºñÁ†ÅÂπ∂ÂèëÈÄÅÂà∞ÊúçÂä°Âô®
            if (socket.connected) {
                const audioBlob = new Blob([outputData.buffer], {type: 'application/octet-stream'});
                const reader = new FileReader();

                reader.onloadend = () => {
                    const base64data = reader.result.split(',')[1];

                    socket.emit('audio_data', {
                        audio: base64data,
                        sampleRate: audioContext.sampleRate
                    });
                };

                reader.readAsDataURL(audioBlob);
            }
        };
    })
    .catch(e => {
        console.error('È∫¶ÂÖãÈ£éËÆøÈóÆÈîôËØØ:', e);
        displayRealtimeText("‚ö†Ô∏è È∫¶ÂÖãÈ£éËÆøÈóÆË¢´ÊãíÁªùÔºåËØ∑ÂÖÅËÆ∏ËÆøÈóÆÈ∫¶ÂÖãÈ£éÂπ∂Âà∑Êñ∞È°µÈù¢ ‚ö†Ô∏è", displayDiv);
    });

/**
 * È™åËØÅOpenWakeWordÊ®°ÂûãË∑ØÂæÑÊ†ºÂºè
 * @param {string} pathsString - Ê®°ÂûãË∑ØÂæÑÂ≠óÁ¨¶‰∏≤ÔºåÁî®ÈÄóÂè∑ÂàÜÈöî
 * @returns {Object} - ÂåÖÂê´È™åËØÅÁªìÊûúÂíåÈîôËØØÊ∂àÊÅØÁöÑÂØπË±°
 */
function validateOpenWakeWordPaths(pathsString) {
    // Á©∫Ë∑ØÂæÑÊòØÂÖÅËÆ∏ÁöÑÔºåË°®Á§∫‰ΩøÁî®È¢ÑËÆ≠ÁªÉÊ®°Âûã
    if (!pathsString || pathsString.trim() === '') {
        return {valid: true, message: ''};
    }

    const paths = pathsString.split(',').map(p => p.trim());
    const results = {valid: true, message: '', invalidPaths: []};

    // Ê£ÄÊü•ÊØè‰∏™Ë∑ØÂæÑ
    for (const path of paths) {
        // Ê£ÄÊü•Âü∫Êú¨Ê†ºÂºè
        if (path.includes('|') || path.includes('>') || path.includes('<') || path.includes('*') || path.includes('?') || path.includes(';')) {
            results.invalidPaths.push(`"${path}" ÂåÖÂê´Êó†ÊïàÂ≠óÁ¨¶ (|, >, <, *, ?, ;)`);
            continue;
        }

        // Ê£ÄÊü•Êñá‰ª∂Êâ©Â±ïÂêç
        const validExtensions = ['.bin', '.onnx', '.tflite'];
        const hasValidExtension = validExtensions.some(ext => path.toLowerCase().endsWith(ext));
        if (!hasValidExtension) {
            results.invalidPaths.push(`"${path}" ‰∏çÊòØÊúâÊïàÁöÑÊ®°ÂûãÊñá‰ª∂ÔºåÂ∫î‰ª• .bin, .onnx Êàñ .tflite ÁªìÂ∞æ`);
            continue;
        }

        // Ê£ÄÊü•Ë∑ØÂæÑÈïøÂ∫¶
        if (path.length > 260) {
            results.invalidPaths.push(`"${path}" Ë∑ØÂæÑËøáÈïøÔºåË∂ÖËøá260‰∏™Â≠óÁ¨¶`);
            continue;
        }

        // Ê£ÄÊü•WindowsË∑ØÂæÑÊ†ºÂºè
        if (path.includes('\\')) {
            // Á°Æ‰øùWindowsË∑ØÂæÑÊ†ºÂºèÊ≠£Á°Æ
            const windowsPathRegex = /^[a-zA-Z]:\\(?:[^\\/:*?"<>|\r\n]+\\)*[^\\/:*?"<>|\r\n]*$/;
            if (!windowsPathRegex.test(path)) {
                results.invalidPaths.push(`"${path}" WindowsË∑ØÂæÑÊ†ºÂºèÊó†Êïà`);
                continue;
            }
        }

        // Ê£ÄÊü•Linux/MacË∑ØÂæÑÊ†ºÂºè
        if (path.startsWith('/')) {
            // Á°Æ‰øùLinux/MacË∑ØÂæÑÊ†ºÂºèÊ≠£Á°Æ
            const unixPathRegex = /^\/(?:[^\/\0]+\/)*[^\/\0]*$/;
            if (!unixPathRegex.test(path)) {
                results.invalidPaths.push(`"${path}" UnixË∑ØÂæÑÊ†ºÂºèÊó†Êïà`);
                continue;
            }
        }

        // Â¶ÇÊûúÊòØÁõ∏ÂØπË∑ØÂæÑ‰ΩÜ‰ª• ./ Êàñ ../ ÂºÄÂ§¥ÔºåÂèØËÉΩÂ≠òÂú®ÂÆâÂÖ®ÈóÆÈ¢ò
        if (path.startsWith('./') || path.startsWith('../')) {
            results.invalidPaths.push(`"${path}" ‰ΩøÁî®Áõ∏ÂØπË∑ØÂæÑÂèØËÉΩÂØºËá¥ÈóÆÈ¢òÔºåÂª∫ËÆÆ‰ΩøÁî®ÁªùÂØπË∑ØÂæÑ`);
            continue;
        }

        // Ê£ÄÊü•ÊòØÂê¶ÂåÖÂê´Á©∫Ê†º‰ΩÜÊ≤°ÊúâÂºïÂè∑ÔºàÂèØËÉΩÂØºËá¥ÂëΩ‰ª§Ë°åËß£ÊûêÈóÆÈ¢òÔºâ
        if (path.includes(' ') && !path.startsWith('"') && !path.endsWith('"')) {
            // ËøôÂè™ÊòØ‰∏Ä‰∏™Ë≠¶ÂëäÔºå‰∏ç‰ºö‰ΩøÈ™åËØÅÂ§±Ë¥•
            results.invalidPaths.push(`Ë≠¶Âëä: "${path}" ÂåÖÂê´Á©∫Ê†ºÔºåÂèØËÉΩÈúÄË¶ÅÁî®ÂºïÂè∑ÂåÖÂõ¥`);
        }
    }

    // Â§ÑÁêÜÈ™åËØÅÁªìÊûú
    if (results.invalidPaths.length > 0) {
        results.valid = false;
        results.message = `ÂèëÁé∞ ${results.invalidPaths.length} ‰∏™ÈóÆÈ¢ò:\n` + results.invalidPaths.join('\n');
    }

    return results;
}

/**
 * ÊòæÁ§∫È™åËØÅÈîôËØØÊ∂àÊÅØ
 * @param {string} inputId - ËæìÂÖ•Ê°ÜID
 * @param {string} message - ÈîôËØØÊ∂àÊÅØ
 */
function showValidationError(inputId, message) {
    const input = document.getElementById(inputId);
    if (!input) return;

    // ËÆæÁΩÆÈîôËØØÊ†∑Âºè
    input.classList.add('validation-error');

    // ÊòæÁ§∫ÈîôËØØÊ∂àÊÅØ
    let errorElem = document.getElementById(`${inputId}-error`);
    if (!errorElem) {
        errorElem = document.createElement('div');
        errorElem.id = `${inputId}-error`;
        errorElem.className = 'validation-error-message';
        input.parentNode.insertBefore(errorElem, input.nextSibling);
    }
    errorElem.textContent = message;
    errorElem.style.display = message ? 'block' : 'none';
}

/**
 * Ê∏ÖÈô§È™åËØÅÈîôËØØÂπ∂ÊòæÁ§∫ÊàêÂäüÁä∂ÊÄÅ
 * @param {string} inputId - ËæìÂÖ•Ê°ÜID
 * @param {boolean} showSuccess - ÊòØÂê¶ÊòæÁ§∫ÊàêÂäüÁä∂ÊÄÅ
 */
function clearValidationError(inputId, showSuccess = false) {
    const input = document.getElementById(inputId);
    if (!input) return;

    input.classList.remove('validation-error');

    const errorElem = document.getElementById(`${inputId}-error`);
    if (errorElem) {
        errorElem.style.display = 'none';
    }

    // Â¶ÇÊûúÈúÄË¶ÅÊòæÁ§∫ÊàêÂäüÁä∂ÊÄÅ
    if (showSuccess) {
        input.classList.add('validation-success');

        // 2ÁßíÂêéÁßªÈô§ÊàêÂäüÁä∂ÊÄÅ
        setTimeout(() => {
            input.classList.remove('validation-success');
        }, 2000);
    }
}

/**
 * È™åËØÅÊñá‰ª∂Ë∑ØÂæÑÊòØÂê¶Â≠òÂú®‰∫éÊúçÂä°Âô®‰∏ä
 * @param {string} path - Ë¶ÅÈ™åËØÅÁöÑÊñá‰ª∂Ë∑ØÂæÑ
 * @returns {Promise} - Ëß£Êûê‰∏∫ÂåÖÂê´È™åËØÅÁªìÊûúÁöÑPromise
 */
function validateFilePath(path) {
    return new Promise((resolve, reject) => {
        // ËÆæÁΩÆË∂ÖÊó∂
        const timeout = setTimeout(() => {
            reject(new Error('È™åËØÅËØ∑Ê±ÇË∂ÖÊó∂'));
        }, 5000);

        // ËØ∑Ê±ÇÈ™åËØÅ
        socket.emit('validate_file_path', {path: path});

        // ‰∏ÄÊ¨°ÊÄß‰∫ã‰ª∂ÁõëÂê¨Âô®
        function validationResultHandler(result) {
            clearTimeout(timeout);
            socket.off('file_path_validation_result', validationResultHandler);
            resolve(result);
        }

        // ÁõëÂê¨È™åËØÅÁªìÊûú
        socket.on('file_path_validation_result', validationResultHandler);
    });
}

/**
 * ÊòæÁ§∫Êñá‰ª∂È™åËØÅÁªìÊûú
 * @param {string} inputId - ËæìÂÖ•Ê°ÜID
 * @param {Object} result - È™åËØÅÁªìÊûú
 */
function showFileValidationResult(inputId, result) {
    const input = document.getElementById(inputId);
    if (!input) return;

    if (result.valid) {
        clearValidationError(inputId, result.path.trim() !== '');
    } else {
        // ÊûÑÂª∫ÈîôËØØÊ∂àÊÅØ
        const errorMessages = result.messages.map(item =>
            `"${item.path}": ${item.reason}`
        ).join('\n');

        showValidationError(inputId, `Êñá‰ª∂Ë∑ØÂæÑÈ™åËØÅÂ§±Ë¥•:\n${errorMessages}`);
    }
}

/**
 * ÊòæÁ§∫ÂêØÂä®ÈîôËØØÂØπËØùÊ°Ü
 * @param {Object} errorData - ÈîôËØØÊï∞ÊçÆÂØπË±°
 */
function showStartupErrorDialog(errorData) {
    console.warn('Ê£ÄÊµãÂà∞‰∏äÊ¨°ÂêØÂä®Â§±Ë¥•:', errorData);

    // ÁßªÈô§ÂèØËÉΩÂ∑≤Â≠òÂú®ÁöÑÂØπËØùÊ°Ü
    const existingOverlay = document.querySelector('.startup-error-overlay');
    if (existingOverlay) {
        document.body.removeChild(existingOverlay);
    }

    // ÂàõÂª∫ÈÅÆÁΩ©Â±Ç
    const overlay = document.createElement('div');
    overlay.className = 'startup-error-overlay';
    overlay.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.5);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 2000;
    `;

    // ÂàõÂª∫ÂØπËØùÊ°ÜÂÆπÂô®
    const dialogContainer = document.createElement('div');
    dialogContainer.style.cssText = `
        background-color: #1e1e1e;
        color: #fff;
        padding: 25px;
        border-radius: 10px;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.5);
        width: 500px;
        max-width: 90%;
        position: relative;
        max-height: 80vh;
        overflow-y: auto;
    `;

    // Ê∑ªÂä†ÂÜÖÂÆπ
    let contentHtml = `
        <div style="display: flex; align-items: center; margin-bottom: 20px;">
            <i class="fas fa-exclamation-triangle" style="color: #ff5252; font-size: 24px; margin-right: 15px;"></i>
            <h3 style="margin: 0; color: #ff5252; font-size: 20px;">ÂêØÂä®ÈîôËØØÊèêÈÜí</h3>
        </div>
        <div style="margin-bottom: 20px; line-height: 1.5;">
            <p><strong>ÈîôËØØ‰ø°ÊÅØ:</strong> ${errorData.message}</p>
            <p><strong>ÂèëÁîüÊó∂Èó¥:</strong> ${errorData.timestamp}</p>
    `;

    // Â¶ÇÊûúÊòØÊ®°ÂûãÊñá‰ª∂ÈóÆÈ¢òÔºåÊ∑ªÂä†ÁâπÊÆäËØ¥Êòé
    if (errorData.message.includes('Ê®°ÂûãÊñá‰ª∂')) {
        contentHtml += `
            <div style="background-color: rgba(255, 82, 82, 0.1); padding: 15px; border-radius: 5px; margin-top: 15px; border-left: 4px solid #ff5252;">
                <p style="margin: 0; font-weight: bold;">Ê®°ÂûãÊñá‰ª∂ÈóÆÈ¢òËØ¥Êòé:</p>
                <p style="margin-top: 10px; margin-bottom: 0;">Á≥ªÁªüÊ£ÄÊµãÂà∞ÊÇ®ÈÖçÁΩÆÁöÑOpenWakeWordÊ®°ÂûãÊñá‰ª∂Â≠òÂú®ÈóÆÈ¢òÔºåÂèØËÉΩÊòØÊñá‰ª∂ÊçüÂùèÊàñÊ†ºÂºè‰∏çÊ≠£Á°Æ„ÄÇÁ≥ªÁªüÂ∑≤Ëá™Âä®Ê∏ÖÁ©∫Ê®°ÂûãË∑ØÂæÑÂπ∂ÊÅ¢Â§ç‰ΩøÁî®ÈªòËÆ§Ê®°Âûã„ÄÇ</p>
            </div>
        `;
    }

    // Ê∑ªÂä†ËØ¶ÁªÜÈîôËØØ‰ø°ÊÅØÔºàÂèØÊäòÂè†Ôºâ
    contentHtml += `
        <div style="margin-top: 20px;">
            <details>
                <summary style="cursor: pointer; color: #00aaff; margin-bottom: 10px;">Êü•ÁúãËØ¶ÁªÜÈîôËØØ‰ø°ÊÅØ</summary>
                <pre style="background-color: #252525; padding: 10px; border-radius: 5px; overflow-x: auto; max-height: 150px; font-size: 12px;">${errorData.error}</pre>
            </details>
        </div>
    `;

    // Ê∑ªÂä†ÂÖ≥Èó≠ÊåâÈíÆ
    contentHtml += `
        <div style="text-align: right; margin-top: 25px;">
            <button id="closeErrorDialogBtn" style="background-color: #00aaff; color: white; border: none; padding: 8px 20px; border-radius: 5px; cursor: pointer; font-weight: bold; transition: all 0.3s;">ÊàëÁü•ÈÅì‰∫Ü</button>
        </div>
    `;

    dialogContainer.innerHTML = contentHtml;
    overlay.appendChild(dialogContainer);
    document.body.appendChild(overlay);

    // ÈòªÊ≠¢ÁÇπÂáªÂØπËØùÊ°ÜÂÜÖÂÆπÊó∂ÂÖ≥Èó≠
    dialogContainer.addEventListener('click', function (e) {
        e.stopPropagation();
    });

    // ÁÇπÂáªÈÅÆÁΩ©Â±ÇËÉåÊôØÂÖ≥Èó≠ÂØπËØùÊ°Ü
    overlay.addEventListener('click', function () {
        document.body.removeChild(overlay);
    });

    // ÁÇπÂáªÂÖ≥Èó≠ÊåâÈíÆÂÖ≥Èó≠ÂØπËØùÊ°Ü
    document.getElementById('closeErrorDialogBtn').addEventListener('click', function () {
        document.body.removeChild(overlay);
    });
} 