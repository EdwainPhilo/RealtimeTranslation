let socket = io();
let displayDiv = document.getElementById('textDisplay');
let server_available = false;
let mic_available = false;
let fullSentences = [];
let currentConfig = {}; // Â≠òÂÇ®ÂΩìÂâçÈÖçÁΩÆ‰ø°ÊÅØ
let waitingForConfigUpdate = false; // ÊòØÂê¶Ê≠£Âú®Á≠âÂæÖÈÖçÁΩÆÊõ¥Êñ∞
let useSimplifiedChinese = true; // ÊòØÂê¶‰ΩøÁî®ÁÆÄ‰Ωì‰∏≠Êñá
let originalFullSentences = []; // ‰øùÂ≠òÂéüÂßãÂè•Â≠êÔºàÊú™ËΩ¨Êç¢ÂâçÔºâ

// Â§ÑÁêÜÊñáÊú¨ËΩ¨Êç¢ÁöÑËæÖÂä©ÂáΩÊï∞
function processText(text) {
    return useSimplifiedChinese ? window.ChineseConverter.convertToSimplified(text) : text;
}

// Êõ¥Êñ∞ÊòæÁ§∫ÊñáÊú¨ÔºàËÄÉËôëÁπÅÁÆÄËΩ¨Êç¢Ôºâ
function updateDisplay() {
    let displayedText = originalFullSentences.map((sentence, index) => {
        const processedSentence = processText(sentence);
        let span = document.createElement('span');
        span.textContent = processedSentence + " ";
        span.className = index % 2 === 0 ? 'yellow' : 'cyan';
        return span.outerHTML;
    }).join('');

    displayDiv.innerHTML = displayedText;
}

// ÂàáÊç¢ÁπÅÁÆÄÊòæÁ§∫Ê®°Âºè
function toggleChineseMode() {
    useSimplifiedChinese = !useSimplifiedChinese;
    // Êõ¥Êñ∞ÊòæÁ§∫
    updateDisplay();
    // Êõ¥Êñ∞ÊåâÈíÆÊñáÊú¨
    const toggleButton = document.getElementById('toggle-chinese-mode');
    if (toggleButton) {
        toggleButton.textContent = useSimplifiedChinese ? 'ÂàáÊç¢Âà∞ÁπÅ‰Ωì' : 'ÂàáÊç¢Âà∞ÁÆÄ‰Ωì';
    }
    
    // ‰øùÂ≠òÁî®Êà∑ÂÅèÂ•ΩÂà∞localStorage
    localStorage.setItem('useSimplifiedChinese', useSimplifiedChinese ? 'true' : 'false');
    
    // ÊòæÁ§∫Áä∂ÊÄÅÊ∂àÊÅØ
    showStatusMessage(useSimplifiedChinese ? 'Â∑≤ÂàáÊç¢Âà∞ÁÆÄ‰Ωì‰∏≠Êñá' : 'Â∑≤ÂàáÊç¢Âà∞ÁπÅ‰Ωì‰∏≠Êñá', true);
}

function displayRealtimeText(realtimeText, displayDiv) {
    let displayedText = fullSentences.map((sentence, index) => {
        let span = document.createElement('span');
        span.textContent = sentence + " ";
        span.className = index % 2 === 0 ? 'yellow' : 'cyan';
        return span.outerHTML;
    }).join('');
    
    // Ê∑ªÂä†ÂÆûÊó∂ÊñáÊú¨ÔºàÂ¶ÇÊûúÊúâÔºâ
    if (realtimeText) {
        let realtimeSpan = document.createElement('span');
        realtimeSpan.textContent = realtimeText;
        realtimeSpan.className = fullSentences.length % 2 === 0 ? 'yellow' : 'cyan';
        displayedText += realtimeSpan.outerHTML;
    }

    displayDiv.innerHTML = displayedText;
}

function start_msg() {
    if (!mic_available)
        displayRealtimeText("üé§  ËØ∑ÂÖÅËÆ∏È∫¶ÂÖãÈ£éËÆøÈóÆ  üé§", displayDiv);
    else if (!server_available)
        displayRealtimeText("üñ•Ô∏è  ËØ∑ÂêØÂä®ÊúçÂä°Âô®  üñ•Ô∏è", displayDiv);
    else
        displayRealtimeText("üëÑ  ÂºÄÂßãËØ¥ËØù  üëÑ", displayDiv);
}

// ÊòæÁ§∫Áä∂ÊÄÅÊ∂àÊÅØ
function showStatusMessage(message, isSuccess) {
    const statusElement = document.getElementById('status-message');
    if (!statusElement) return;
    
    statusElement.textContent = message;
    
    if (isSuccess) {
        statusElement.className = 'status-message success';
    } else {
        statusElement.className = 'status-message error';
    }
    
    // 3ÁßíÂêéËá™Âä®ÈöêËóè
    setTimeout(() => {
        statusElement.className = 'status-message';
    }, 3000);
}

// Êõ¥Êñ∞UI‰ª•ÂåπÈÖçÈÖçÁΩÆ
function updateSettingsUI(config) {
    if (!config) return;
    
    // Êõ¥Êñ∞Âü∫Êú¨ËÆæÁΩÆ
    if (config.model && document.getElementById('model-size')) {
        document.getElementById('model-size').value = config.model;
    }
    
    if (config.language !== undefined && document.getElementById('language')) {
        document.getElementById('language').value = config.language || '';
    }
    
    if (config.realtime_model_type && document.getElementById('realtime-model')) {
        document.getElementById('realtime-model').value = config.realtime_model_type;
    }
    
    // Êõ¥Êñ∞ËΩ¨ÂÜôËÆæÁΩÆ
    if (config.compute_type && document.getElementById('compute-type')) {
        document.getElementById('compute-type').value = config.compute_type;
    }
    
    if (config.beam_size !== undefined && document.getElementById('beam-size')) {
        document.getElementById('beam-size').value = config.beam_size.toString();
    }
    
    if (config.batch_size !== undefined && document.getElementById('batch-size')) {
        document.getElementById('batch-size').value = config.batch_size.toString();
    }
    
    if (config.beam_size_realtime !== undefined && document.getElementById('beam-size-realtime')) {
        document.getElementById('beam-size-realtime').value = config.beam_size_realtime.toString();
    }
    
    if (config.initial_prompt !== undefined && document.getElementById('initial-prompt')) {
        document.getElementById('initial-prompt').value = config.initial_prompt || '';
    }
    
    if (config.initial_prompt_realtime !== undefined && document.getElementById('initial-prompt-realtime')) {
        document.getElementById('initial-prompt-realtime').value = config.initial_prompt_realtime || '';
    }
    
    // Êõ¥Êñ∞ÂÆûÊó∂ËΩ¨ÂÜôËÆæÁΩÆ
    if (config.enable_realtime_transcription !== undefined && document.getElementById('enable-realtime')) {
        document.getElementById('enable-realtime').value = config.enable_realtime_transcription ? 'true' : 'false';
    }
    
    if (config.use_main_model_for_realtime !== undefined && document.getElementById('use-main-model-realtime')) {
        document.getElementById('use-main-model-realtime').value = config.use_main_model_for_realtime ? 'true' : 'false';
    }
    
    if (config.realtime_processing_pause !== undefined && document.getElementById('realtime-processing-pause')) {
        document.getElementById('realtime-processing-pause').value = config.realtime_processing_pause;
        document.getElementById('realtime-processing-pause-value').textContent = config.realtime_processing_pause;
    }
    
    if (config.init_realtime_after_seconds !== undefined && document.getElementById('init-realtime-after')) {
        document.getElementById('init-realtime-after').value = config.init_realtime_after_seconds;
        document.getElementById('init-realtime-after-value').textContent = config.init_realtime_after_seconds;
    }
    
    if (config.realtime_batch_size !== undefined && document.getElementById('realtime-batch-size')) {
        document.getElementById('realtime-batch-size').value = config.realtime_batch_size.toString();
    }
    
    // Êõ¥Êñ∞ËØ≠Èü≥Ê¥ªÂä®Ê£ÄÊµãËÆæÁΩÆ
    if (config.silero_sensitivity !== undefined && document.getElementById('silero-sensitivity')) {
        document.getElementById('silero-sensitivity').value = config.silero_sensitivity;
        document.getElementById('silero-value').textContent = config.silero_sensitivity;
    }
    
    if (config.silero_use_onnx !== undefined && document.getElementById('silero-use-onnx')) {
        document.getElementById('silero-use-onnx').value = config.silero_use_onnx ? 'true' : 'false';
    }
    
    if (config.silero_deactivity_detection !== undefined && document.getElementById('silero-deactivity')) {
        document.getElementById('silero-deactivity').value = config.silero_deactivity_detection ? 'true' : 'false';
    }
    
    if (config.webrtc_sensitivity !== undefined && document.getElementById('webrtc-sensitivity')) {
        document.getElementById('webrtc-sensitivity').value = config.webrtc_sensitivity;
        document.getElementById('webrtc-value').textContent = config.webrtc_sensitivity;
    }
    
    if (config.post_speech_silence_duration !== undefined && document.getElementById('silence-duration')) {
        document.getElementById('silence-duration').value = config.post_speech_silence_duration;
        document.getElementById('silence-value').textContent = config.post_speech_silence_duration;
    }
    
    if (config.min_length_of_recording !== undefined && document.getElementById('min-recording-length')) {
        document.getElementById('min-recording-length').value = config.min_length_of_recording;
        document.getElementById('min-recording-length-value').textContent = config.min_length_of_recording;
    }
    
    if (config.min_gap_between_recordings !== undefined && document.getElementById('min-gap')) {
        document.getElementById('min-gap').value = config.min_gap_between_recordings;
        document.getElementById('min-gap-value').textContent = config.min_gap_between_recordings;
    }
    
    if (config.pre_recording_buffer_duration !== undefined && document.getElementById('pre-recording-buffer')) {
        document.getElementById('pre-recording-buffer').value = config.pre_recording_buffer_duration;
        document.getElementById('pre-recording-buffer-value').textContent = config.pre_recording_buffer_duration;
    }
    
    // Êõ¥Êñ∞Âî§ÈÜíËØçËÆæÁΩÆ
    if (config.wakeword_backend !== undefined && document.getElementById('wakeword-backend')) {
        document.getElementById('wakeword-backend').value = config.wakeword_backend;
    }

    if (config.wake_words !== undefined && document.getElementById('wake-words')) {
        document.getElementById('wake-words').value = config.wake_words;
    }
    
    if (config.wake_words_sensitivity !== undefined && document.getElementById('wake-words-sensitivity')) {
        document.getElementById('wake-words-sensitivity').value = config.wake_words_sensitivity;
        document.getElementById('wake-words-sensitivity-value').textContent = config.wake_words_sensitivity;
    }
    
    if (config.wake_word_timeout !== undefined && document.getElementById('wake-word-timeout')) {
        document.getElementById('wake-word-timeout').value = config.wake_word_timeout;
        document.getElementById('wake-word-timeout-value').textContent = config.wake_word_timeout;
    }
    
    if (config.wake_word_buffer_duration !== undefined && document.getElementById('wake-word-buffer')) {
        document.getElementById('wake-word-buffer').value = config.wake_word_buffer_duration;
        document.getElementById('wake-word-buffer-value').textContent = config.wake_word_buffer_duration;
    }
    
    // Êõ¥Êñ∞Á≥ªÁªüËÆæÁΩÆ
    if (config.buffer_size !== undefined && document.getElementById('buffer-size')) {
        document.getElementById('buffer-size').value = config.buffer_size.toString();
    }
    
    if (config.sample_rate !== undefined && document.getElementById('sample-rate')) {
        document.getElementById('sample-rate').value = config.sample_rate.toString();
    }
    
    if (config.suppress_tokens !== undefined && document.getElementById('suppress-tokens')) {
        document.getElementById('suppress-tokens').value = config.suppress_tokens.join(',');
    }
    
    if (config.print_transcription_time !== undefined && document.getElementById('print-transcription-time')) {
        document.getElementById('print-transcription-time').value = config.print_transcription_time ? 'true' : 'false';
    }
    
    if (config.early_transcription_on_silence !== undefined && document.getElementById('early-transcription-silence')) {
        document.getElementById('early-transcription-silence').value = config.early_transcription_on_silence;
        document.getElementById('early-transcription-silence-value').textContent = config.early_transcription_on_silence;
    }
    
    if (config.allowed_latency_limit !== undefined && document.getElementById('allowed-latency')) {
        document.getElementById('allowed-latency').value = config.allowed_latency_limit;
        document.getElementById('allowed-latency-value').textContent = config.allowed_latency_limit;
    }
    
    if (config.debug_mode !== undefined && document.getElementById('debug-mode')) {
        document.getElementById('debug-mode').value = config.debug_mode ? 'true' : 'false';
    }
    
    if (config.handle_buffer_overflow !== undefined && document.getElementById('handle-buffer-overflow')) {
        document.getElementById('handle-buffer-overflow').value = config.handle_buffer_overflow ? 'true' : 'false';
    }
    
    if (config.no_log_file !== undefined && document.getElementById('no-log-file')) {
        document.getElementById('no-log-file').value = config.no_log_file ? 'true' : 'false';
    }
    
    if (config.use_extended_logging !== undefined && document.getElementById('use-extended-logging')) {
        document.getElementById('use-extended-logging').value = config.use_extended_logging ? 'true' : 'false';
    }
}

// ‰ªéUIËé∑ÂèñÂΩìÂâçÈÖçÁΩÆ
function getConfigFromUI() {
    const config = {
        // Âü∫Êú¨ËÆæÁΩÆ
        'model': document.getElementById('model-size').value,
        'language': document.getElementById('language').value,
        'download_root': null,
        'compute_type': document.getElementById('compute-type').value,
        'input_device_index': null,
        'gpu_device_index': 0,
        'device': 'cuda',
        'spinner': false,
        'use_microphone': false,
        'ensure_sentence_starting_uppercase': true,
        'ensure_sentence_ends_with_period': true,
        'batch_size': parseInt(document.getElementById('batch-size').value),
        'level': 30, // WARNING Á∫ßÂà´
        
        // ÂÆûÊó∂ËΩ¨ÂÜôËÆæÁΩÆ
        'enable_realtime_transcription': document.getElementById('enable-realtime').value === 'true',
        'use_main_model_for_realtime': document.getElementById('use-main-model-realtime').value === 'true',
        'realtime_model_type': document.getElementById('realtime-model').value,
        'realtime_processing_pause': parseFloat(document.getElementById('realtime-processing-pause').value),
        'init_realtime_after_seconds': parseFloat(document.getElementById('init-realtime-after').value),
        'realtime_batch_size': parseInt(document.getElementById('realtime-batch-size').value),
        
        // ËØ≠Èü≥Ê¥ªÂä®Ê£ÄÊµãËÆæÁΩÆ
        'silero_sensitivity': parseFloat(document.getElementById('silero-sensitivity').value),
        'silero_use_onnx': document.getElementById('silero-use-onnx').value === 'true',
        'silero_deactivity_detection': document.getElementById('silero-deactivity').value === 'true',
        'webrtc_sensitivity': parseInt(document.getElementById('webrtc-sensitivity').value),
        'post_speech_silence_duration': parseFloat(document.getElementById('silence-duration').value),
        'min_length_of_recording': parseFloat(document.getElementById('min-recording-length').value),
        'min_gap_between_recordings': parseFloat(document.getElementById('min-gap').value),
        'pre_recording_buffer_duration': parseFloat(document.getElementById('pre-recording-buffer').value),
        
        // Âî§ÈÜíËØçËÆæÁΩÆ
        'wakeword_backend': document.getElementById('wakeword-backend').value,
        'openwakeword_model_paths': null,
        'openwakeword_inference_framework': "onnx",
        'wake_words': document.getElementById('wake-words').value,
        'wake_words_sensitivity': parseFloat(document.getElementById('wake-words-sensitivity').value),
        'wake_word_activation_delay': 0.0,
        'wake_word_timeout': parseFloat(document.getElementById('wake-word-timeout').value),
        'wake_word_buffer_duration': parseFloat(document.getElementById('wake-word-buffer').value),
        
        // È´òÁ∫ßËÆæÁΩÆ
        'beam_size': parseInt(document.getElementById('beam-size').value),
        'beam_size_realtime': parseInt(document.getElementById('beam-size-realtime').value),
        'buffer_size': parseInt(document.getElementById('buffer-size').value),
        'sample_rate': parseInt(document.getElementById('sample-rate').value),
        'initial_prompt': document.getElementById('initial-prompt').value || null,
        'initial_prompt_realtime': document.getElementById('initial-prompt-realtime').value || null,
        'suppress_tokens': [-1], // Ëß£Êûêsuppress-tokensÁöÑÂÄºÂèØËÉΩÈúÄË¶ÅÊõ¥Â§çÊùÇÁöÑÈÄªËæë
        'print_transcription_time': document.getElementById('print-transcription-time').value === 'true',
        'early_transcription_on_silence': parseFloat(document.getElementById('early-transcription-silence').value),
        'allowed_latency_limit': parseFloat(document.getElementById('allowed-latency').value),
        'debug_mode': document.getElementById('debug-mode').value === 'true',
        'handle_buffer_overflow': document.getElementById('handle-buffer-overflow').value === 'true',
        'no_log_file': document.getElementById('no-log-file').value === 'true',
        'use_extended_logging': document.getElementById('use-extended-logging').value === 'true'
    };
    
    // Â§ÑÁêÜsuppress-tokens
    if (document.getElementById('suppress-tokens').value) {
        try {
            const tokens = document.getElementById('suppress-tokens').value.split(',').map(t => parseInt(t.trim()));
            if (tokens.length > 0 && !isNaN(tokens[0])) {
                config.suppress_tokens = tokens;
            }
        } catch (e) {
            console.warn("Êó†Ê≥ïËß£Êûêsuppress-tokensÂÄºÔºå‰ΩøÁî®ÈªòËÆ§ÂÄº");
        }
    }
    
    return config;
}

// ÂàùÂßãÂåñSocket.IOËøûÊé•
socket.on('connect', function() {
    server_available = true;
    start_msg();
    
    // ËøûÊé•ÂêéËØ∑Ê±ÇÂΩìÂâçÈÖçÁΩÆ
    socket.emit('get_config');
});

socket.on('disconnect', function() {
    server_available = false;
    start_msg();
});

socket.on('realtime', function(data) {
    if (data.type === 'realtime') {
        // ‰ΩøÁî®ËæÖÂä©ÂáΩÊï∞Â§ÑÁêÜÊñáÊú¨
        const processedText = processText(data.text);
        displayRealtimeText(processedText, displayDiv);
    }
});

socket.on('fullSentence', function(data) {
    if (data.type === 'fullSentence') {
        // ‰øùÂ≠òÂéüÂßãÂè•Â≠êÔºàÊú™ËΩ¨Êç¢Ôºâ
        originalFullSentences.push(data.text);
        // ‰ΩøÁî®ËæÖÂä©ÂáΩÊï∞Â§ÑÁêÜÊñáÊú¨
        const processedText = processText(data.text);
        fullSentences.push(processedText);
        
        // Êõ¥Êñ∞ÊòæÁ§∫
        updateDisplay();
    }
});

// Êé•Êî∂ÊúçÂä°Âô®ÈÖçÁΩÆ
socket.on('config', function(config) {
    currentConfig = config;
    updateSettingsUI(config);
    console.log('Êî∂Âà∞ÊúçÂä°Âô®ÈÖçÁΩÆ:', config);
});

// ÈÖçÁΩÆÊõ¥Êñ∞ÂìçÂ∫î
socket.on('config_updated', function(response) {
    if (response.success) {
        currentConfig = response.config;
        updateSettingsUI(response.config);
        showStatusMessage('ËÆæÁΩÆÂ∑≤ÊàêÂäüÂ∫îÁî®ÔºåÁ≠âÂæÖÂΩïÈü≥Êú∫Â∞±Áª™...', true);
        // ËÆ∞ÂΩïÊ≠£Âú®Á≠âÂæÖÂΩïÈü≥Êú∫Â∞±Áª™
        waitingForConfigUpdate = true;
    } else {
        showStatusMessage('ËÆæÁΩÆÂ∫îÁî®Â§±Ë¥•: ' + response.error, false);
        // ÈÖçÁΩÆÊõ¥Êñ∞Â§±Ë¥•ÔºåÈáçÁΩÆÁ≠âÂæÖÁä∂ÊÄÅ
        waitingForConfigUpdate = false;
    }
});

// ËÆæÁΩÆÂΩïÈü≥Êú∫Áä∂ÊÄÅ
socket.on('recorder_status', function(data) {
    if (data.ready) {
        if (waitingForConfigUpdate) {
            // Â¶ÇÊûúÊòØÈÖçÁΩÆÊõ¥Êñ∞ÂêéÁöÑÁä∂ÊÄÅÂèòÊõ¥ÔºåÂàôÂÖ≥Èó≠ËÆæÁΩÆÈù¢Êùø
            waitingForConfigUpdate = false;
            showStatusMessage('ÂΩïÈü≥Êú∫Â∑≤ÂáÜÂ§áÂ∞±Áª™', true);
            
            // Âª∂Ëøü‰∏ÄÁßíÂÖ≥Èó≠ËÆæÁΩÆÈù¢ÊùøÔºåËÆ©Áî®Êà∑ÁúãÂà∞ÊàêÂäüÊ∂àÊÅØ
            setTimeout(() => {
                const settingsOverlay = document.getElementById('settingsOverlay');
                if (settingsOverlay) {
                    settingsOverlay.style.display = 'none';
                }
            }, 1000);
        } else {
            showStatusMessage('ÂΩïÈü≥Êú∫Â∑≤ÂáÜÂ§áÂ∞±Áª™', true);
        }
    } else {
        showStatusMessage('ÂΩïÈü≥Êú∫Êú™Â∞±Áª™', false);
    }
});

// Â§ÑÁêÜÂ∫îÁî®ÈáçÂêØÊ∂àÊÅØ
socket.on('restart_required', function(data) {
    console.log('Â∫îÁî®Âç≥Â∞ÜÈáçÂêØ:', data);
    
    // ÂàõÂª∫ÈáçÂêØÊèêÁ§∫ÂØπËØùÊ°Ü
    const restartDialog = document.createElement('div');
    restartDialog.style.position = 'fixed';
    restartDialog.style.top = '50%';
    restartDialog.style.left = '50%';
    restartDialog.style.transform = 'translate(-50%, -50%)';
    restartDialog.style.backgroundColor = '#333';
    restartDialog.style.color = '#fff';
    restartDialog.style.padding = '20px';
    restartDialog.style.borderRadius = '8px';
    restartDialog.style.boxShadow = '0 4px 15px rgba(0, 0, 0, 0.3)';
    restartDialog.style.zIndex = '2000';
    restartDialog.style.textAlign = 'center';
    
    // Ê∑ªÂä†ÂõæÊ†áÂíåÊñáÂ≠ó
    restartDialog.innerHTML = `
        <div style="font-size: 24px; margin-bottom: 15px;">
            <i class="fas fa-sync-alt" style="color: #00aaff;"></i>
        </div>
        <div style="font-size: 18px; margin-bottom: 15px;">
            ${data.message || 'Â∫îÁî®Ê≠£Âú®ÈáçÂêØ...'}
        </div>
        <div style="font-size: 16px;" id="restart-countdown">
            È°µÈù¢Â∞ÜÂú® <span style="color: #00aaff; font-weight: bold;">${data.countdown || 5}</span> ÁßíÂêéËá™Âä®Âà∑Êñ∞
        </div>
    `;
    
    // Ê∑ªÂä†Âà∞È°µÈù¢
    document.body.appendChild(restartDialog);
    
    // ËÆæÁΩÆÂÄíËÆ°Êó∂
    let countdown = data.countdown || 5;
    const countdownInterval = setInterval(() => {
        countdown--;
        const countdownElement = document.getElementById('restart-countdown');
        if (countdownElement) {
            countdownElement.innerHTML = `È°µÈù¢Â∞ÜÂú® <span style="color: #00aaff; font-weight: bold;">${countdown}</span> ÁßíÂêéËá™Âä®Âà∑Êñ∞`;
        }
        
        if (countdown <= 0) {
            clearInterval(countdownInterval);
            // Âà∑Êñ∞È°µÈù¢
            window.location.reload();
        }
    }, 1000);
});

start_msg();

// ÂΩìDOMÂä†ËΩΩÂÆåÊàêÔºåËÆæÁΩÆÊåâÈíÆ‰∫ã‰ª∂
document.addEventListener('DOMContentLoaded', function() {
    const applySettingsBtn = document.getElementById('apply-settings');
    if (applySettingsBtn) {
        applySettingsBtn.addEventListener('click', function() {
            const config = getConfigFromUI();
            socket.emit('update_config', config);
            console.log('ÂèëÈÄÅÈÖçÁΩÆÂà∞ÊúçÂä°Âô®:', config);
            
            // ÊòæÁ§∫Ê≠£Âú®Êõ¥Êñ∞ÁöÑÊ∂àÊÅØ
            showStatusMessage('Ê≠£Âú®Â∫îÁî®ËÆæÁΩÆ...', true);
            // ‰∏çÁ´ãÂç≥ÂÖ≥Èó≠ËÆæÁΩÆÈù¢ÊùøÔºåËÄåÊòØÁ≠âÂæÖÂìçÂ∫î
            waitingForConfigUpdate = true;
        });
    }
    
    // ÊÅ¢Â§çÈªòËÆ§ËÆæÁΩÆÊåâÈíÆ
    const resetToDefaultBtn = document.getElementById('reset-to-default');
    if (resetToDefaultBtn) {
        resetToDefaultBtn.addEventListener('click', function() {
            if (confirm('Á°ÆÂÆöË¶ÅÊÅ¢Â§çÊâÄÊúâËÆæÁΩÆÂà∞ÈªòËÆ§ÂÄºÂêóÔºüÊ≠§Êìç‰ΩúÊó†Ê≥ïÊí§ÈîÄ„ÄÇ')) {
                socket.emit('reset_to_default');
                console.log('ÂèëÈÄÅÊÅ¢Â§çÈªòËÆ§ËÆæÁΩÆËØ∑Ê±Ç');
                
                // ÊòæÁ§∫Ê≠£Âú®ÊÅ¢Â§çÁöÑÊ∂àÊÅØ
                showStatusMessage('Ê≠£Âú®ÊÅ¢Â§çÈªòËÆ§ËÆæÁΩÆ...', true);
            }
        });
    }

    // ‰ªélocalStorageÂä†ËΩΩÁî®Êà∑ÁöÑÁÆÄÁπÅ‰∏≠ÊñáÂÅèÂ•Ω
    const savedPreference = localStorage.getItem('useSimplifiedChinese');
    if (savedPreference !== null) {
        useSimplifiedChinese = savedPreference === 'true';
        // Êõ¥Êñ∞ÂàáÊç¢ÊåâÈíÆÊñáÊú¨
        const toggleButton = document.getElementById('toggle-chinese-mode');
        if (toggleButton) {
            toggleButton.textContent = useSimplifiedChinese ? 'ÂàáÊç¢Âà∞ÁπÅ‰Ωì' : 'ÂàáÊç¢Âà∞ÁÆÄ‰Ωì';
        }
    }

    // Ëé∑ÂèñÊåâÈíÆÂíåÂØπËØùÊ°ÜÂÖÉÁ¥†
    const shutdownIcon = document.getElementById('shutdownIcon');
    const shutdownDialog = document.getElementById('shutdownConfirmDialog');
    const confirmShutdownBtn = document.getElementById('confirmShutdown');
    const cancelShutdownBtn = document.getElementById('cancelShutdown');
    
    // ÊòæÁ§∫Á°ÆËÆ§ÂØπËØùÊ°Ü
    shutdownIcon.addEventListener('click', function() {
        shutdownDialog.style.display = 'flex';
    });
    
    // ÂèñÊ∂àÂÖ≥Èó≠
    cancelShutdownBtn.addEventListener('click', function() {
        shutdownDialog.style.display = 'none';
    });
    
    // Á°ÆËÆ§ÂÖ≥Èó≠
    confirmShutdownBtn.addEventListener('click', function() {
        shutdownDialog.style.display = 'none';
        
        // ÂèëÈÄÅÂÖ≥Èó≠ËØ∑Ê±ÇÂà∞ÊúçÂä°Âô®
        socket.emit('shutdown_service');
        
        // ÊòæÁ§∫ÂÖ≥Èó≠Áä∂ÊÄÅ
        displayDiv.innerHTML = '<span class="shutdown-message">ÊúçÂä°Ê≠£Âú®ÂÖ≥Èó≠ÔºåËØ∑Á®çÂÄô...</span>';
    });
    
    // ÁÇπÂáªÂØπËØùÊ°ÜÂ§ñÈÉ®Âå∫ÂüüÂÖ≥Èó≠ÂØπËØùÊ°Ü
    shutdownDialog.addEventListener('click', function(event) {
        if (event.target === shutdownDialog) {
            shutdownDialog.style.display = 'none';
        }
    });
    
    // ÁõëÂê¨ÊúçÂä°ÂÖ≥Èó≠‰∫ã‰ª∂
    socket.on('service_shutdown', function(data) {
        console.log('ÊúçÂä°Ê≠£Âú®ÂÖ≥Èó≠:', data);
        
        // ÊòæÁ§∫ÂÖ≥Èó≠ÂÄíËÆ°Êó∂
        displayDiv.innerHTML = `<span class="shutdown-message">ÊúçÂä°Ê≠£Âú®ÂÖ≥Èó≠Ôºå${data.countdown}ÁßíÂêéÂ∞ÜËá™Âä®Êñ≠ÂºÄËøûÊé•...</span>`;
        
        // ÂÄíËÆ°Êó∂ÁªìÊùüÂêéÂà∑Êñ∞È°µÈù¢
        setTimeout(function() {
            displayDiv.innerHTML = '<span class="shutdown-message">ÊúçÂä°Â∑≤ÂÖ≥Èó≠ÔºåËØ∑ÂÖ≥Èó≠ÊµèËßàÂô®ÊàñÂà∑Êñ∞È°µÈù¢ÈáçÊñ∞ËøûÊé•</span>';
        }, data.countdown * 1000);
    });
});

// ËØ∑Ê±ÇÈ∫¶ÂÖãÈ£éËÆøÈóÆÊùÉÈôê
navigator.mediaDevices.getUserMedia({ audio: true })
.then(stream => {
    let audioContext = new AudioContext();
    let source = audioContext.createMediaStreamSource(stream);
    let processor = audioContext.createScriptProcessor(256, 1, 1);

    source.connect(processor);
    processor.connect(audioContext.destination);
    mic_available = true;
    start_msg();

    processor.onaudioprocess = function(e) {
        let inputData = e.inputBuffer.getChannelData(0);
        let outputData = new Int16Array(inputData.length);

        // Convert to 16-bit PCM
        for (let i = 0; i < inputData.length; i++) {
            outputData[i] = Math.max(-32768, Math.min(32767, inputData[i] * 32768));
        }

        // Â∞ÜÈü≥È¢ëÊï∞ÊçÆËΩ¨Êç¢‰∏∫ Base64 ÁºñÁ†ÅÂπ∂ÂèëÈÄÅÂà∞ÊúçÂä°Âô®
        if (socket.connected) {
            const audioBlob = new Blob([outputData.buffer], { type: 'application/octet-stream' });
            const reader = new FileReader();
            
            reader.onloadend = () => {
                const base64data = reader.result.split(',')[1];
                
                socket.emit('audio_data', {
                    audio: base64data,
                    sampleRate: audioContext.sampleRate
                });
            };
            
            reader.readAsDataURL(audioBlob);
        }
    };
})
.catch(e => {
    console.error('È∫¶ÂÖãÈ£éËÆøÈóÆÈîôËØØ:', e);
    displayRealtimeText("‚ö†Ô∏è È∫¶ÂÖãÈ£éËÆøÈóÆË¢´ÊãíÁªùÔºåËØ∑ÂÖÅËÆ∏ËÆøÈóÆÈ∫¶ÂÖãÈ£éÂπ∂Âà∑Êñ∞È°µÈù¢ ‚ö†Ô∏è", displayDiv);
}); 